<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Prerequisite​ &mdash; Intel® Extension for Transformers 0.1.dev1+g14734de documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/graphviz.css?v=fd3f3429" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/custom.css?v=68dfede1" />

  
<script type="text/javascript">
  // Configure TMS settings
  window.wapProfile = 'profile-microsite'; // This is mapped by WAP authorize value
  window.wapLocalCode = 'us-en'; // Dynamically set per localized site, see mapping table for values
  window.wapSection = "intel-extension-for-transformers"; // WAP team will give you a unique section for your site
  window.wapEnv = 'prod'; // environment to be use in Adobe Tags.
  // Load TMS
  (() => {
        let url = 'https://www.intel.com/content/dam/www/global/wap/main/wap-microsite.js';
        let po = document.createElement('script'); po.type = 'text/javascript'; po.async = true; po.src = url;
        let s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  }) ();
</script>

    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../index.html" class="icon icon-home">
            Intel® Extension for Transformers
          </a>
            <div class="version">
              <a href="../../../../../../versions.html">latest▼</a>
              <p>Click link above to switch version</p>
            </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../user_guide.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../example.html">Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api_doc/api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../SECURITY.html">Security Policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../release.html">Release</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../legal.html">Legal Information</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/intel/intel-extension-for-transformers">Repo</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">Intel® Extension for Transformers</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Prerequisite​</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../../_sources/docs/intel_extension_for_transformers/neural_chat/docker/finetuning/README.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <p>Intel Neural Chat Finetuning Dockerfile installer for Ubuntu22.04</p>
<section id="prerequisite">
<h1>Prerequisite​<a class="headerlink" href="#prerequisite" title="Link to this heading"></a></h1>
<section id="prepare-dataset">
<h2>1. Prepare Dataset<a class="headerlink" href="#prepare-dataset" title="Link to this heading"></a></h2>
<p>The instruction-following dataset is needed for the finetuning. We select two kinds of Datasets to conduct the finetuning process: general domain dataset and domain specific dataset.</p>
<ol class="simple">
<li><p>General domain dataset: We use the <a class="reference external" href="https://github.com/tatsu-lab/stanford_alpaca">Alpaca dataset</a> from Stanford University as the general domain dataset to fine-tune the model. This dataset is provided in the form of a JSON file, <a class="reference external" href="https://github.com/tatsu-lab/stanford_alpaca/blob/main/alpaca_data.json">alpaca_data.json</a>. In Alpaca, researchers have manually crafted 175 seed tasks to guide <code class="docutils literal notranslate"><span class="pre">text-davinci-003</span></code> in generating 52K instruction data for diverse tasks.</p></li>
<li><p>Domain-specific dataset: Inspired by Alpaca, we constructed a domain-specific dataset focusing on Business and Intel-related issues. We made minor modifications to the <a class="reference external" href="https://github.com/tatsu-lab/stanford_alpaca/blob/main/prompt.txt">prompt template</a> to proactively guide Alpaca in generating more Intel and Business related instruction data. The generated data could be find in <code class="docutils literal notranslate"><span class="pre">intel_domain.json</span></code>.</p></li>
</ol>
</section>
<section id="prepare-docker-image">
<h2>2. Prepare Docker Image<a class="headerlink" href="#prepare-docker-image" title="Link to this heading"></a></h2>
<section id="build-docker-image">
<h3>2.1 Build Docker Image<a class="headerlink" href="#build-docker-image" title="Link to this heading"></a></h3>
<blockquote>
<div><p><strong>Note</strong>: If your docker daemon is too big and cost long time to build docker image, you could create a <code class="docutils literal notranslate"><span class="pre">.dockerignore</span></code> file including useless files to reduce the daemon size.</p>
</div></blockquote>
<section id="please-clone-a-itrex-repo-to-this-path">
<h4>Please clone a ITREX repo to this path.<a class="headerlink" href="#please-clone-a-itrex-repo-to-this-path" title="Link to this heading"></a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/intel/intel-extension-for-transformers.git
<span class="nb">cd</span><span class="w"> </span>intel-extension-for-transformers
</pre></div>
</div>
<p>If you need to set proxy settings, add <code class="docutils literal notranslate"><span class="pre">--build-arg</span> <span class="pre">https_proxy=$https_proxy</span> <span class="pre">--build-arg</span> <span class="pre">http_proxy=$http_proxy</span></code> when <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">build</span></code>.</p>
<p>If you need to use your branch, add <code class="docutils literal notranslate"><span class="pre">--build-arg</span> <span class="pre">ITREX_VER=&quot;${your_branch}</span></code> when <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">build</span></code>.</p>
<p>If you need to clone repo in docker, add <code class="docutils literal notranslate"><span class="pre">--build-arg</span> <span class="pre">REPO=&quot;${you_repo_path}&quot;</span></code> when <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">build</span></code>.</p>
<p>If you need to use local repository, add <code class="docutils literal notranslate"><span class="pre">--build-arg</span> <span class="pre">REPO_PATH=&quot;.&quot;</span></code> when <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">build</span></code>.</p>
</section>
<section id="on-xeon-spr-environment">
<h4>On Xeon SPR Environment<a class="headerlink" href="#on-xeon-spr-environment" title="Link to this heading"></a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker<span class="w"> </span>build<span class="w"> </span>--build-arg<span class="w"> </span><span class="nv">UBUNTU_VER</span><span class="o">=</span><span class="m">22</span>.04<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>--target<span class="w"> </span>cpu<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>-t<span class="w"> </span>intel/intel-extension-for-transformers:finetuning-1.4.0<span class="w"> </span>.<span class="w"> </span>
</pre></div>
</div>
</section>
<section id="on-habana-gaudi-environment">
<h4>On Habana Gaudi Environment<a class="headerlink" href="#on-habana-gaudi-environment" title="Link to this heading"></a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker<span class="w"> </span>build<span class="w"> </span>--build-arg<span class="w"> </span><span class="nv">UBUNTU_VER</span><span class="o">=</span><span class="m">22</span>.04<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>--target<span class="w"> </span>hpu<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>-t<span class="w"> </span>intel/intel-extension-for-transformers:finetuning-1.4.0<span class="w"> </span>.<span class="w"> </span>
</pre></div>
</div>
</section>
<section id="on-nvidia-gpu-environment">
<h4>On Nvidia GPU Environment<a class="headerlink" href="#on-nvidia-gpu-environment" title="Link to this heading"></a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker<span class="w"> </span>build<span class="w"> </span>--target<span class="w"> </span>nvgpu<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>-t<span class="w"> </span>intel/intel-extension-for-transformers:finetuning-1.4.0<span class="w"> </span>.<span class="w"> </span>
</pre></div>
</div>
</section>
</section>
<section id="docker-pull-from-docker-hub">
<h3>2.2 Docker Pull from Docker Hub<a class="headerlink" href="#docker-pull-from-docker-hub" title="Link to this heading"></a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker<span class="w"> </span>pull<span class="w"> </span>intel/intel-extension-for-transformers:finetuning-1.4.0
</pre></div>
</div>
</section>
</section>
<section id="create-docker-container">
<h2>3. Create Docker Container<a class="headerlink" href="#create-docker-container" title="Link to this heading"></a></h2>
<p>If you have downloaded model and datasets before, just mount the <code class="docutils literal notranslate"><span class="pre">model</span> <span class="pre">files</span></code> and <code class="docutils literal notranslate"><span class="pre">alpaca_data.json</span></code> to the docker container using <code class="docutils literal notranslate"><span class="pre">'-v'</span></code>. Make sure using the <code class="docutils literal notranslate"><span class="pre">absolute</span> <span class="pre">path</span></code> for local files.</p>
<p>If your environment requires a proxy to access the internet, export your development system’s proxy settings to the docker environment:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">DOCKER_RUN_ENVS</span><span class="o">=</span><span class="s2">&quot;-e https_proxy=</span><span class="nv">$https_proxy</span><span class="s2"> -e http_proxy=</span><span class="nv">$http_proxy</span><span class="s2"> -e no_proxy=&quot;</span>localhost,127.0.0.1<span class="s2">&quot;</span>
</pre></div>
</div>
<section id="id1">
<h3>On Xeon SPR Environment<a class="headerlink" href="#id1" title="Link to this heading"></a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker<span class="w"> </span>run<span class="w"> </span>-it<span class="w"> </span>--disable-content-trust<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>--privileged<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>--name<span class="o">=</span><span class="s2">&quot;chatbot&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">       </span>--hostname<span class="o">=</span><span class="s2">&quot;chatbot-container&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">       </span>--network<span class="o">=</span>host<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>-v<span class="w"> </span>/dev/shm:/dev/shm<span class="w"> </span><span class="se">\</span>
<span class="w">       </span><span class="si">${</span><span class="nv">DOCKER_RUN_ENVS</span><span class="si">}</span><span class="w"> </span><span class="se">\</span>
<span class="w">       </span>intel/intel-extension-for-transformers:finetuning-1.4.0<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>/bin/bash
</pre></div>
</div>
<p>If you want to use local datasets and models, use <code class="docutils literal notranslate"><span class="pre">-v</span></code> to mount files</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">MODEL_DIR</span><span class="o">=</span>&lt;absolute<span class="w"> </span>path<span class="w"> </span>to<span class="w"> </span>flan<span class="w"> </span>t5<span class="w"> </span>xl<span class="w"> </span>model<span class="w"> </span>directory&gt;
<span class="nb">export</span><span class="w"> </span><span class="nv">DATASET_FILE</span><span class="o">=</span>&lt;absolute<span class="w"> </span>path<span class="w"> </span>Alapaca<span class="w"> </span>data<span class="w"> </span>file&gt;
docker<span class="w"> </span>run<span class="w"> </span>-it<span class="w"> </span>--disable-content-trust<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>--privileged<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>--name<span class="o">=</span><span class="s2">&quot;chatbot&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">       </span>--hostname<span class="o">=</span><span class="s2">&quot;chatbot-container&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">       </span>--network<span class="o">=</span>host<span class="w"> </span><span class="si">${</span><span class="nv">DOCKER_RUN_ENVS</span><span class="si">}</span><span class="w">  </span><span class="se">\</span>
<span class="w">       </span>-v<span class="w"> </span>/dev/shm:/dev/shm<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>-v<span class="w"> </span><span class="si">${</span><span class="nv">MODEL_DIR</span><span class="si">}</span>:/flan<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>-v<span class="w"> </span><span class="si">${</span><span class="nv">DATASET_FILE</span><span class="si">}</span>:/dataset/alpaca_data.json<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>intel/intel-extension-for-transformers:finetuning-1.4.0<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>/bin/bash
</pre></div>
</div>
</section>
<section id="id2">
<h3>On Habana Gaudi Environment<a class="headerlink" href="#id2" title="Link to this heading"></a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker<span class="w"> </span>run<span class="w"> </span>-it<span class="w"> </span>--runtime<span class="o">=</span>habana<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>--name<span class="o">=</span><span class="s2">&quot;chatbot&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">       </span>-e<span class="w"> </span><span class="nv">HABANA_VISIBLE_DEVICES</span><span class="o">=</span>all<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>-e<span class="w"> </span><span class="nv">OMPI_MCA_btl_vader_single_copy_mechanism</span><span class="o">=</span>none<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>-v<span class="w"> </span>/dev/shm:/dev/shm<span class="w"> </span><span class="se">\</span>
<span class="w">       </span><span class="si">${</span><span class="nv">DOCKER_RUN_ENVS</span><span class="si">}</span><span class="w"> </span><span class="se">\</span>
<span class="w">       </span>--cap-add<span class="o">=</span>sys_nice<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>--net<span class="o">=</span>host<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>--ipc<span class="o">=</span>host<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>intel/intel-extension-for-transformers:finetuning-1.4.0<span class="w"> </span>/bin/bash
</pre></div>
</div>
<p>If you want to use local datasets and models, use <code class="docutils literal notranslate"><span class="pre">-v</span></code> to mount files.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">MODEL_DIR</span><span class="o">=</span>&lt;absolute<span class="w"> </span>path<span class="w"> </span>to<span class="w"> </span>flan<span class="w"> </span>t5<span class="w"> </span>xl<span class="w"> </span>model<span class="w"> </span>directory&gt;
<span class="nb">export</span><span class="w"> </span><span class="nv">DATASET_FILE</span><span class="o">=</span>&lt;absolute<span class="w"> </span>path<span class="w"> </span>Alapaca<span class="w"> </span>data<span class="w"> </span>file&gt;
docker<span class="w"> </span>run<span class="w"> </span>-it<span class="w"> </span>--runtime<span class="o">=</span>habana<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>--name<span class="o">=</span><span class="s2">&quot;chatbot&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">       </span>-e<span class="w"> </span><span class="nv">HABANA_VISIBLE_DEVICES</span><span class="o">=</span>all<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>-e<span class="w"> </span><span class="nv">OMPI_MCA_btl_vader_single_copy_mechanism</span><span class="o">=</span>none<span class="w"> </span><span class="se">\</span>
<span class="w">       </span><span class="si">${</span><span class="nv">DOCKER_RUN_ENVS</span><span class="si">}</span><span class="w"> </span><span class="se">\</span>
<span class="w">       </span>-v<span class="w"> </span>/dev/shm:/dev/shm<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>-v<span class="w"> </span><span class="si">${</span><span class="nv">MODEL_DIR</span><span class="si">}</span>:/flan<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>-v<span class="w"> </span><span class="si">${</span><span class="nv">DATASET_FILE</span><span class="si">}</span>:/dataset/alpaca_data.json<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>--cap-add<span class="o">=</span>sys_nice<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>--net<span class="o">=</span>host<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>--ipc<span class="o">=</span>host<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>intel/intel-extension-for-transformers:finetuning-1.4.0<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>/bin/bash
</pre></div>
</div>
</section>
<section id="id3">
<h3>On Nvidia GPU Environment<a class="headerlink" href="#id3" title="Link to this heading"></a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker<span class="w"> </span>run<span class="w"> </span>--gpus<span class="w"> </span>all<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>-it<span class="w"> </span>--disable-content-trust<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>--privileged<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>--name<span class="o">=</span><span class="s2">&quot;chatbot&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">       </span>--hostname<span class="o">=</span><span class="s2">&quot;chatbot-container&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">       </span>--network<span class="o">=</span>host<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>-v<span class="w"> </span>/dev/shm:/dev/shm<span class="w"> </span><span class="se">\</span>
<span class="w">       </span><span class="si">${</span><span class="nv">DOCKER_RUN_ENVS</span><span class="si">}</span><span class="w"> </span><span class="se">\</span>
<span class="w">       </span>intel/intel-extension-for-transformers:finetuning-1.4.0<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>/bin/bash
</pre></div>
</div>
<p>If you want to use local datasets and models, use <code class="docutils literal notranslate"><span class="pre">-v</span></code> to mount files.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">MODEL_DIR</span><span class="o">=</span>&lt;absolute<span class="w"> </span>path<span class="w"> </span>to<span class="w"> </span>flan<span class="w"> </span>t5<span class="w"> </span>xl<span class="w"> </span>model<span class="w"> </span>directory&gt;
<span class="nb">export</span><span class="w"> </span><span class="nv">DATASET_FILE</span><span class="o">=</span>&lt;absolute<span class="w"> </span>path<span class="w"> </span>Alapaca<span class="w"> </span>data<span class="w"> </span>file&gt;
docker<span class="w"> </span>run<span class="w"> </span>--gpus<span class="w"> </span>all<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>-it<span class="w"> </span>--disable-content-trust<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>--privileged<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>--name<span class="o">=</span><span class="s2">&quot;chatbot&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">       </span>--hostname<span class="o">=</span><span class="s2">&quot;chatbot-container&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">       </span>--network<span class="o">=</span>host<span class="w"> </span><span class="se">\</span>
<span class="w">       </span><span class="si">${</span><span class="nv">DOCKER_RUN_ENVS</span><span class="si">}</span><span class="w"> </span><span class="se">\</span>
<span class="w">       </span>-v<span class="w"> </span>/dev/shm:/dev/shm<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>-v<span class="w"> </span><span class="si">${</span><span class="nv">MODEL_DIR</span><span class="si">}</span>:/flan<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>-v<span class="w"> </span><span class="si">${</span><span class="nv">DATASET_FILE</span><span class="si">}</span>:/dataset/alpaca_data.json<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>intel/intel-extension-for-transformers:finetuning-1.4.0<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>/bin/bash
</pre></div>
</div>
</section>
</section>
<section id="simple-test-using-docker-container">
<h2>4. Simple Test using Docker Container<a class="headerlink" href="#simple-test-using-docker-container" title="Link to this heading"></a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1">## if you are already inside the container, skip this step</span>
docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>chatbot<span class="w"> </span>/bin/bash
<span class="c1">## run finetuning unittest</span>
<span class="nb">cd</span><span class="w"> </span>tests/nightly
python<span class="w"> </span>finetuning/test_finetuning_data.py
</pre></div>
</div>
</section>
</section>
<section id="finetune">
<h1>Finetune<a class="headerlink" href="#finetune" title="Link to this heading"></a></h1>
<p>We employ the <a class="reference external" href="https://arxiv.org/pdf/2106.09685.pdf">LoRA approach</a> to finetune the LLM efficiently.</p>
<section id="single-node-fine-tuning-in-xeon-spr">
<h2>1. Single Node Fine-tuning  in Xeon SPR<a class="headerlink" href="#single-node-fine-tuning-in-xeon-spr" title="Link to this heading"></a></h2>
<p>For FLAN-T5, use the below command line for finetuning on the Alpaca dataset. If you mounted model and dataset into docker, please make sure the file path is correct.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>finetune_seq2seq.py<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--model_name_or_path<span class="w"> </span><span class="s2">&quot;/flan&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--train_file<span class="w"> </span><span class="s2">&quot;/dataset/alpaca_data.json&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--per_device_train_batch_size<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--per_device_eval_batch_size<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--gradient_accumulation_steps<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--do_train<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--learning_rate<span class="w"> </span><span class="m">1</span>.0e-5<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--warmup_ratio<span class="w"> </span><span class="m">0</span>.03<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--weight_decay<span class="w"> </span><span class="m">0</span>.0<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--num_train_epochs<span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--logging_steps<span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--save_steps<span class="w"> </span><span class="m">2000</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--save_total_limit<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--overwrite_output_dir<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--output_dir<span class="w"> </span>./flan-t5-xl_peft_finetuned_model<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--peft<span class="w"> </span>lora
</pre></div>
</div>
<p>For LLaMA2, use the below command line for finetuning on the Alpaca dataset.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>finetune_clm.py<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--model_name_or_path<span class="w"> </span><span class="s2">&quot;meta-llama/Llama-2-7b-chat-hf&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--train_file<span class="w"> </span><span class="s2">&quot;/dataset/alpaca_data.json&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--dataset_concatenation<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--per_device_train_batch_size<span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--per_device_eval_batch_size<span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--gradient_accumulation_steps<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--do_train<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--learning_rate<span class="w"> </span>2e-5<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--num_train_epochs<span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--logging_steps<span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--save_total_limit<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--overwrite_output_dir<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--log_level<span class="w"> </span>info<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--save_strategy<span class="w"> </span>epoch<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--output_dir<span class="w"> </span>./llama2_peft_finetuned_model<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--peft<span class="w"> </span>lora<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--use_fast_tokenizer<span class="w"> </span><span class="nb">false</span>
</pre></div>
</div>
<p>For <a class="reference external" href="https://huggingface.co/mosaicml/mpt-7b">MPT</a>, use the below command line for finetuning on the Alpaca dataset. Only LORA supports MPT in PEFT perspective.it uses gpt-neox-20b tokenizer, so you need to define it in command line explicitly.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>finetune_clm.py<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--model_name_or_path<span class="w"> </span><span class="s2">&quot;mosaicml/mpt-7b&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--bf16<span class="w"> </span>True<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--train_file<span class="w"> </span><span class="s2">&quot;/path/to/alpaca_data.json&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--dataset_concatenation<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--per_device_train_batch_size<span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--per_device_eval_batch_size<span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--gradient_accumulation_steps<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--do_train<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--learning_rate<span class="w"> </span>1e-4<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--num_train_epochs<span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--logging_steps<span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--save_total_limit<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--overwrite_output_dir<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--log_level<span class="w"> </span>info<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--save_strategy<span class="w"> </span>epoch<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--output_dir<span class="w"> </span>./mpt_peft_finetuned_model<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--peft<span class="w"> </span>lora<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--tokenizer_name<span class="w"> </span><span class="s2">&quot;EleutherAI/gpt-neox-20b&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--no_cuda<span class="w"> </span><span class="se">\</span>
</pre></div>
</div>
<p>Where the <code class="docutils literal notranslate"><span class="pre">--dataset_concatenation</span></code> argument is a way to vastly accelerate the fine-tuning process through training samples concatenation. With several tokenized sentences concatenated into a longer and concentrated sentence as the training sample instead of having several training samples with different lengths, this way is more efficient due to the parallelism characteristic provided by the more concentrated training samples.</p>
<p>For finetuning on SPR, add <code class="docutils literal notranslate"><span class="pre">--bf16</span></code> argument will speedup the finetuning process without the loss of model’s performance.
You could also indicate <code class="docutils literal notranslate"><span class="pre">--peft</span></code> to switch peft method in P-tuning, Prefix tuning, Prompt tuning, LLama Adapter, LoRA,
see https://github.com/huggingface/peft. Note for FLAN-T5/MPT, only LoRA is supported.</p>
</section>
<section id="multi-node-fine-tuning-in-xeon-spr">
<h2>2. Multi-node Fine-tuning in Xeon SPR<a class="headerlink" href="#multi-node-fine-tuning-in-xeon-spr" title="Link to this heading"></a></h2>
<p>We also supported Distributed Data Parallel finetuning on single node and multi-node settings. To use Distributed Data Parallel to speedup training, the bash command needs a small adjustment.
<br>
For example, to finetune FLAN-T5 through Distributed Data Parallel training, bash command will look like the following, where
<br>
<em><code class="docutils literal notranslate"><span class="pre">&lt;MASTER_ADDRESS&gt;</span></code></em> is the address of the master node, it won’t be necessary for single node case,
<br>
<em><code class="docutils literal notranslate"><span class="pre">&lt;NUM_PROCESSES_PER_NODE&gt;</span></code></em> is the desired processes to use in current node, for node with GPU, usually set to number of GPUs in this node, for node without GPU and use CPU for training, it’s recommended set to 1,
<br>
<em><code class="docutils literal notranslate"><span class="pre">&lt;NUM_NODES&gt;</span></code></em> is the number of nodes to use,
<br>
<em><code class="docutils literal notranslate"><span class="pre">&lt;NODE_RANK&gt;</span></code></em> is the rank of the current node, rank starts from 0 to <em><code class="docutils literal notranslate"><span class="pre">&lt;NUM_NODES&gt;</span></code></em><code class="docutils literal notranslate"><span class="pre">-1</span></code>.
<br></p>
<blockquote>
<div><p>Also please note that to use CPU for training in each node with multi-node settings, argument <code class="docutils literal notranslate"><span class="pre">--no_cuda</span></code> is mandatory, and <code class="docutils literal notranslate"><span class="pre">--ddp_backend</span> <span class="pre">ccl</span></code> is required if to use ccl as the distributed backend. In multi-node setting, following command needs to be launched in each node, and all the commands should be the same except for <em><code class="docutils literal notranslate"><span class="pre">&lt;NODE_RANK&gt;</span></code></em>, which should be integer from 0 to <em><code class="docutils literal notranslate"><span class="pre">&lt;NUM_NODES&gt;</span></code></em><code class="docutils literal notranslate"><span class="pre">-1</span></code> assigned to each node.</p>
</div></blockquote>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mpirun<span class="w"> </span>-f<span class="w"> </span>nodefile<span class="w"> </span>-n<span class="w"> </span><span class="m">16</span><span class="w"> </span>-ppn<span class="w"> </span><span class="m">4</span><span class="w"> </span>-genv<span class="w"> </span><span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="m">56</span><span class="w"> </span>python3<span class="w"> </span>instruction_tuning_pipeline/finetune_seq2seq.py<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--model_name_or_path<span class="w"> </span><span class="s2">&quot;google/flan-t5-xl&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--bf16<span class="w"> </span>True<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--train_file<span class="w"> </span><span class="s2">&quot;stanford_alpaca/alpaca_data.json&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--per_device_train_batch_size<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--per_device_eval_batch_size<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--gradient_accumulation_steps<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--do_train<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--learning_rate<span class="w"> </span><span class="m">1</span>.0e-5<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--warmup_ratio<span class="w"> </span><span class="m">0</span>.03<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--weight_decay<span class="w"> </span><span class="m">0</span>.0<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--num_train_epochs<span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--logging_steps<span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--save_steps<span class="w"> </span><span class="m">2000</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--save_total_limit<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--overwrite_output_dir<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--output_dir<span class="w"> </span>./flan-t5-xl_peft_finetuned_model<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--peft<span class="w"> </span>lora<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--no_cuda<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--ddp_backend<span class="w"> </span>ccl<span class="w"> </span><span class="se">\</span>
</pre></div>
</div>
<p>If you have enabled passwordless SSH in cpu clusters, you could also use mpirun in master node to start the DDP finetune. Take llama2 alpaca finetune for example. follow the <a class="reference external" href="https://huggingface.co/docs/transformers/perf_train_cpu_many">hugginface guide</a> to install Intel® oneCCL Bindings for PyTorch, IPEX</p>
<p>oneccl_bindings_for_pytorch is installed along with the MPI tool set. Need to source the environment before using it.</p>
<p>for Intel® oneCCL &gt;= 1.12.0</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">oneccl_bindings_for_pytorch_path</span><span class="o">=</span><span class="k">$(</span>python<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;from oneccl_bindings_for_pytorch import cwd; print(cwd)&quot;</span><span class="k">)</span>
<span class="nb">source</span><span class="w"> </span><span class="nv">$oneccl_bindings_for_pytorch_path</span>/env/setvars.sh
</pre></div>
</div>
<p>for Intel® oneCCL whose version &lt; 1.12.0</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">torch_ccl_path</span><span class="o">=</span><span class="k">$(</span>python<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;import torch; import torch_ccl; import os;  print(os.path.abspath(os.path.dirname(torch_ccl.__file__)))&quot;</span><span class="k">)</span>
<span class="nb">source</span><span class="w"> </span><span class="nv">$torch_ccl_path</span>/env/setvars.sh
</pre></div>
</div>
<p>The following command enables training with a total of 16 processes on 4 Xeons (node0/1/2/3, 2 sockets each node. taking node0 as the master node), ppn (processes per node) is set to 4, with two processes running per one socket. The variables OMP_NUM_THREADS/CCL_WORKER_COUNT can be tuned for optimal performance.</p>
<p>In node0, you need to create a configuration file which contains the IP addresses of each node (for example hostfile) and pass that configuration file path as an argument.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="w"> </span>cat<span class="w"> </span>hostfile
<span class="w"> </span>xxx.xxx.xxx.xxx<span class="w"> </span><span class="c1">#node0 ip</span>
<span class="w"> </span>xxx.xxx.xxx.xxx<span class="w"> </span><span class="c1">#node1 ip</span>
<span class="w"> </span>xxx.xxx.xxx.xxx<span class="w"> </span><span class="c1">#node2 ip</span>
<span class="w"> </span>xxx.xxx.xxx.xxx<span class="w"> </span><span class="c1">#node3 ip</span>
</pre></div>
</div>
<p>Now, run the following command in node0 and <strong>4DDP</strong> will be enabled in node0 and node1 with BF16 auto mixed precision:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">CCL_WORKER_COUNT</span><span class="o">=</span><span class="m">1</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">MASTER_ADDR</span><span class="o">=</span>xxx.xxx.xxx.xxx<span class="w"> </span><span class="c1">#node0 ip</span>
<span class="c1">## for DDP ptun for LLama2</span>
mpirun<span class="w"> </span>-f<span class="w"> </span>nodefile<span class="w"> </span>-n<span class="w"> </span><span class="m">16</span><span class="w"> </span>-ppn<span class="w"> </span><span class="m">4</span><span class="w"> </span>-genv<span class="w"> </span><span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="m">56</span><span class="w"> </span>python3<span class="w"> </span>finetune_clm.py<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--model_name_or_path<span class="w"> </span>meta-llama/Llama-2-7b-chat-hf<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--train_file<span class="w"> </span>./alpaca_data.json<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--bf16<span class="w"> </span>True<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--output_dir<span class="w"> </span>./llama2_peft_finetuned_model<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--num_train_epochs<span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--per_device_train_batch_size<span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--per_device_eval_batch_size<span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--gradient_accumulation_steps<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--evaluation_strategy<span class="w"> </span><span class="s2">&quot;no&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--save_strategy<span class="w"> </span><span class="s2">&quot;steps&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--save_steps<span class="w"> </span><span class="m">2000</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--save_total_limit<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--learning_rate<span class="w"> </span>1e-4<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--logging_steps<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--peft<span class="w"> </span>ptun<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--group_by_length<span class="w"> </span>True<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--dataset_concatenation<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--use_fast_tokenizer<span class="w"> </span><span class="nb">false</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--do_train<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--no_cuda<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--ddp_backend<span class="w"> </span>ccl<span class="w"> </span><span class="se">\</span>

<span class="c1">## for DDP LORA for MPT</span>
mpirun<span class="w"> </span>-f<span class="w"> </span>nodefile<span class="w"> </span>-n<span class="w"> </span><span class="m">16</span><span class="w"> </span>-ppn<span class="w"> </span><span class="m">4</span><span class="w"> </span>-genv<span class="w"> </span><span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="m">56</span><span class="w"> </span>python3<span class="w"> </span>finetune_clm.py<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--model_name_or_path<span class="w"> </span>mosaicml/mpt-7b<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--train_file<span class="w"> </span>./alpaca_data.json<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--bf16<span class="w"> </span>True<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--output_dir<span class="w"> </span>./mpt_peft_finetuned_model<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--num_train_epochs<span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--per_device_train_batch_size<span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--per_device_eval_batch_size<span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--gradient_accumulation_steps<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--evaluation_strategy<span class="w"> </span><span class="s2">&quot;no&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--save_strategy<span class="w"> </span><span class="s2">&quot;steps&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--save_steps<span class="w"> </span><span class="m">2000</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--save_total_limit<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--learning_rate<span class="w"> </span>1e-4<span class="w">  </span><span class="se">\</span>
<span class="w">    </span>--logging_steps<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--peft<span class="w"> </span>lora<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--group_by_length<span class="w"> </span>True<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--dataset_concatenation<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--do_train<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--tokenizer_name<span class="w"> </span><span class="s2">&quot;EleutherAI/gpt-neox-20b&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--no_cuda<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--ddp_backend<span class="w"> </span>ccl<span class="w"> </span><span class="se">\</span>
</pre></div>
</div>
<p>you could also indicate <code class="docutils literal notranslate"><span class="pre">--peft</span></code> to switch peft method in P-tuning, Prefix tuning, Prompt tuning, LLama Adapter, LORA,
see https://github.com/huggingface/peft</p>
</section>
<section id="single-node-fine-tuning-in-habana-dl1">
<h2>3. Single Node Fine-tuning in Habana DL1<a class="headerlink" href="#single-node-fine-tuning-in-habana-dl1" title="Link to this heading"></a></h2>
<p>Follow install guidance in <a class="reference external" href="https://github.com/huggingface/optimum-habana">optimum-habana</a></p>
<p>For LLaMA2, use the below command line for finetuning on the Alpaca dataset.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>finetune_clm.py<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--model_name_or_path<span class="w"> </span><span class="s2">&quot;meta-llama/Llama-2-7b-chat-hf&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--bf16<span class="w"> </span>True<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--train_file<span class="w"> </span><span class="s2">&quot;/path/to/alpaca_data.json&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--dataset_concatenation<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--per_device_train_batch_size<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--per_device_eval_batch_size<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--gradient_accumulation_steps<span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--do_train<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--learning_rate<span class="w"> </span>1e-4<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--num_train_epochs<span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--logging_steps<span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--save_total_limit<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--overwrite_output_dir<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--log_level<span class="w"> </span>info<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--save_strategy<span class="w"> </span>epoch<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--output_dir<span class="w"> </span>./llama2_peft_finetuned_model<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--peft<span class="w"> </span>lora<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--use_fast_tokenizer<span class="w"> </span><span class="nb">false</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--habana<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--use_habana<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--use_lazy_mode<span class="w"> </span><span class="se">\</span>
</pre></div>
</div>
<p>For <a class="reference external" href="https://huggingface.co/mosaicml/mpt-7b">MPT</a>, use the below command line for finetuning on the Alpaca dataset. Only LORA supports MPT in PEFT perspective.it uses gpt-neox-20b tokenizer, so you need to define it in command line explicitly.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>finetune_clm.py<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--model_name_or_path<span class="w"> </span><span class="s2">&quot;mosaicml/mpt-7b&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--bf16<span class="w"> </span>True<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--train_file<span class="w"> </span><span class="s2">&quot;/path/to/alpaca_data.json&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--dataset_concatenation<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--per_device_train_batch_size<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--per_device_eval_batch_size<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--gradient_accumulation_steps<span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--do_train<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--learning_rate<span class="w"> </span>1e-4<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--num_train_epochs<span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--logging_steps<span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--save_total_limit<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--overwrite_output_dir<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--log_level<span class="w"> </span>info<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--save_strategy<span class="w"> </span>epoch<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--output_dir<span class="w"> </span>./mpt_peft_finetuned_model<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--peft<span class="w"> </span>lora<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--tokenizer_name<span class="w"> </span><span class="s2">&quot;EleutherAI/gpt-neox-20b&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--habana<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--use_habana<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--use_lazy_mode<span class="w"> </span><span class="se">\</span>
</pre></div>
</div>
<p>Where the <code class="docutils literal notranslate"><span class="pre">--dataset_concatenation</span></code> argument is a way to vastly accelerate the fine-tuning process through training samples concatenation. With several tokenized sentences concatenated into a longer and concentrated sentence as the training sample instead of having several training samples with different lengths, this way is more efficient due to the parallelism characteristic provided by the more concentrated training samples.</p>
<p>For finetuning on SPR, add <code class="docutils literal notranslate"><span class="pre">--bf16</span></code> argument will speedup the finetuning process without the loss of model’s performance.
You could also indicate <code class="docutils literal notranslate"><span class="pre">--peft</span></code> to switch peft method in P-tuning, Prefix tuning, Prompt tuning, LLama Adapter, LoRA,
see https://github.com/huggingface/peft. Note for MPT, only LoRA is supported.</p>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Intel® Extension for Transformers, Intel.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   <jinja2.runtime.BlockReference object at 0x7f8ca1250310> 
  <p></p><div><a href='https://www.intel.com/content/www/us/en/privacy/intel-cookie-notice.html' data-cookie-notice='true'>Cookies</a> <a href='https://www.intel.com/content/www/us/en/privacy/intel-privacy-notice.html'>| Privacy</a></div>


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>